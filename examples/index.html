<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    
    <title>Toubkal - Examples</title>
    
    <!-- Bootstrap version 3.3.4 CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css">
    <link rel="stylesheet" type="text/css" href="http://fonts.googleapis.com/css?family=Lato:400,700,400italic|Oswald&subset=latin,latin-ext"/>
    <link href="css/base.css"  type="text/css" rel="stylesheet" /> <!-- base css style for all web pages -->
    
    <script src="/socket.io/socket.io.js"></script>
    
    <script src="/lib/toubkal-min.js"></script>
  </head>
  
  <body>
    <h4>Connection State:</h4>
    <ul id="connection_state"></ul>
    
    <h4>Toubkal Examples:</h4>
    
    <ul id="examples">
      <!--li id="to_dom-1-2">
        <a id="to_dom-2-2">to_dom-2-2</a>
      </li-->
    </ul>
    
    <script>
      // live reload
      rs.socket_io_server()
        .flow( 'assets' )
        .trace( 'assets' )
        .delay( 500 )
        .alter( function( asset ) {
          window.location.reload()
        } )
      ;
    </script>
    
    <script>
      rs.socket_io_state_changes()
        //.trace( 'socket_io_state_changes' )
        
        .map( function( v ) {
          return {
            id : 1,
            
            content: v.connected ? 'On' : 'Off',
            
            attributes: {
              title: v.state + ' @' + v.timestamp + ' (' + v.address + ')',
              
              style: {
                'color': v.connected ? 'green' : 'red'
              }
            }
          }
        } )
        
        .last()
        
        .$to_dom( rs
          .socket_io_state_changes()
          .filter( [ { connected: true } ] )
          .last()
          // last() does not emit remove operations, so query selector 
          // remains valid when disconnected, until a new connected state
          // updates the output
          .$query_selector( '#connection_state' )
          //.trace( '#connection_state', { fetch_source_rx: true } )
        )
      ;
      
      rs.socket_io_server()
        .Singleton( '$examples', function( source, options ) {
          return source
            //.trace( 'examples' )
            .$query_selector( '#examples' )
          ;
        } )
        
        .flow( 'examples', { key: [ 'id' ] } )
        
        .optimize()
        
        //.trace( 'before order' )
        
        .order( [ { id: 'title' } ] )
        
        .trace( 'before examples' )
        
        .$to_dom( rs.$examples() )
        
        //.trace( 'after examples' )
        
        .set_output( '$li' )
      ;
      
      rs.once( 1000 )
        .alter( function( v ) {
          rs.output( '$li' )
            .alter( function( v ) {
              v.tag = 'a';
              v.content = v.title;
              v.attributes = rs.RS.extend( { href: v.path }, v.attributes );
            } )
            
            //.trace( 'before a' )
            
            .$to_dom()
            //.trace( 'after a' )
            .greedy()
          ;
        } )
      ;
      
      var beat = 20000;
      
      rs//.beat( beat )
        .once( 0 )
        .$examples()
      ;
      
      rs//.once( beat * 0.9 )
        .map( function( v ) { return { interval: beat } } )
        .beat()
        .revert()
        .$examples()
      ;
    </script>
  </body>
</html>
